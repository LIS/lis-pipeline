#!/usr/bin/env groovy

env.LISAV2_REMOTE = "https://github.com/lis/LISAv2.git"
env.LISAV2_BRANCH = "master"
env.LISAV2_RG_IDENTIFIER = "developerk"
env.LISAV2_AZURE_UBUNTU_IMAGE_BIONIC = "Canonical UbuntuServer 18.04-DAILY-LTS latest"
env.LISAV2_HYPERV_UBUNTU_IMAGE_BIONIC = "Ubuntu_18.04.1"
env.LISAV2_AZURE_STRESS_TEST = "STRESSTEST-VERIFY-RESTART"
env.LISAV2_PERFORMANCE_TEST = "PERF-NETWORK-TCP-SINGLE-CONNECTION-THROUGHPUT-SYNTHETIC"
env.KERNEL_ARTIFACTS_PATH = "dev-patch-kernels"
env.PACKAGE_TYPE = "deb"
env.PARAM_SEPARATOR_STYLE = 'font-size: 15px; font-weight: 600;'

def runs = [:]

properties ([
    overrideIndexTriggers(false),
    [$class: 'ParametersDefinitionProperty',
        parameterDefinitions: [
        [$class: 'ParameterSeparatorDefinition',
            separatorStyle: "",
            sectionHeader: "KERNEL BUILD CONFIGURATION",
            sectionHeaderStyle: env.PARAM_SEPARATOR_STYLE],
        [$class: 'ChoiceParameterDefinition',
            name: 'KERNEL_GIT_URL',
            choices: """git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git\nhttps://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git\nazure_kernel""",
            description: 'Kernel tree repo'],
        [$class: 'StringParameterDefinition',
            name: 'KERNEL_GIT_BRANCH',
            defaultValue: 'master',
            description: 'Branch to be built'],
        [$class: 'StringParameterDefinition',
            name: 'KERNEL_PATCH',
            defaultValue: "",
            description: 'Valid examples: \n scp://my-scp-hostname:/home/my-username/patch.p1 \n scp://my-username@my-scp-hostname:/home/my-username/patch.p1 \n http://my-website.com/patch.p1 \n Use the space separator for multiple patches.'],
        [$class: 'StringParameterDefinition',
            name: 'KERNEL_ARTIFACTS_SMB_PATH',
            defaultValue: "",
            description: 'The already built kernel artifacts path from the share. Ex: linux-next/linux-next-4.20.0-e6c7317-28112018-unpatched-19. BUILD_KERNEL_ARTIFACTS step has to be unchecked.'],
        [$class: 'BooleanParameterDefinition',
            defaultValue: true,
            name: 'BUILD_KERNEL_ARTIFACTS',
            description: 'Whether to build kernel artifacts'],
        [$class: 'ParameterSeparatorDefinition',
            separatorStyle: "",
            sectionHeader: "TEST CONFIGURATION",
            sectionHeaderStyle: env.PARAM_SEPARATOR_STYLE],
        [$class: 'ChoiceParameterDefinition',
            choices: """westus2\naustraliaeast\naustraliasoutheast\nbrazilsouth\ncanadacentral
                        canadaeast\ncentralindia\ncentralus\neastasia\neastus\neastus2\nfrancecentral
                        japaneast\njapanwest\nkoreacentral\nkoreasouth\nnorthcentralus\nnortheurope
                        southcentralus\nsoutheastasia\nsouthindia\nuksouth\nukwest\nwestcentralus
                        westeurope\nwestindia\nwestus\nsepremium""",
            name: 'LISAV2_AZURE_REGION',
            description: 'Azure Region'],
        [$class: 'ParameterSeparatorDefinition',
            separatorStyle: "",
            sectionHeader: "AZURE BOOT TEST CONFIGURATION",
            sectionHeaderStyle: env.PARAM_SEPARATOR_STYLE],
        [$class: 'BooleanParameterDefinition',
            defaultValue: true,
            name: 'RUN_AZURE_BOOT_TEST',
            description: 'Whether to run Azure Boot test'],
        [$class: 'ParameterSeparatorDefinition',
            separatorStyle: "",
            sectionHeader: "AZURE BOOT STRESS TEST CONFIGURATION",
            sectionHeaderStyle: env.PARAM_SEPARATOR_STYLE],
        [$class: 'BooleanParameterDefinition',
            defaultValue: false,
            name: 'RUN_AZURE_BOOT_STRESS_TEST',
            description: 'Whether to run Azure Boot Stress test (100 iterations)'],
        [$class: 'ChoiceParameterDefinition',
            name: 'AZURE_BOOT_STRESS_VM_SIZE',
            choices: "Standard_A2\nStandard_E64_v3\nStandard_F72s_v2",
            description: 'Azure Boot Stress vm size'],
        [$class: 'ParameterSeparatorDefinition',
            separatorStyle: "",
            sectionHeader: "FUNCTIONAL TEST CONFIGURATION",
            sectionHeaderStyle: env.PARAM_SEPARATOR_STYLE],
        [$class: 'BooleanParameterDefinition',
            defaultValue: false,
            name: 'RUN_AZURE_BVT_TESTS',
            description: 'Whether to run Azure basic validation tests'],
        [$class: 'BooleanParameterDefinition',
            defaultValue: false,
            name: 'RUN_HYPERV_BVT_TESTS',
            description: 'Whether to run HYPERV basic validation tests'],
        [$class: 'ParameterSeparatorDefinition',
            separatorStyle: "",
            sectionHeader: "AZURE PERFOMANCE TEST CONFIGURATION",
            sectionHeaderStyle: env.PARAM_SEPARATOR_STYLE],
        [$class: 'ChoiceParameterDefinition',
            choices: """NONE
                    STORAGE
                    NETWORK""",
            name: 'AZURE_PERF_TESTS',
            description: 'What Azure Performance tests to run. You can customize the test cases from the options below. STORAGE TBD.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """4k
                    1024k""",
            name: 'AZURE_PERF_STORAGE_IO_SIZE',
            description: 'Azure Performance STORAGE IO SIZE. TBD.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """ALL
                    randread
                    randwrite
                    read
                    write""",
            name: 'AZURE_PERF_STORAGE_IO_MODE',
            description: 'Azure Performance STORAGE IO MODE.  TBD.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """IPERF3_1CONNECTION
                    NTTTCP_TCP
                    NTTTCP_UDP""",
            name: 'AZURE_PERF_NETWORK_TEST_TYPE',
            description: 'Azure Performance Network testing type. NTTTCP_TCP and NTTTCP_UDP TBD.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """SYNTHETIC
                    SRIOV""",
            name: 'NET_IPERF3_TYPE',
            description: 'Azure Performance NETWORK IPERF3 1CONNECTION: SYNTHETIC or SRIOV type.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """ALL
                    32\n64\n128\n256\n512\n1024\n2048\n4096\n8192\n16384\n32768\n65536""",
            name: 'NET_IPERF3_BUFFER_LENGTH',
            description: 'Azure Performance NETWORK IPERF3 1CONNECTION BUFFER LENGTH.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """SYNTHETIC
                    SRIOV""",
            name: 'NTTTCP_TCP_TYPE',
            description: 'Azure Performance NETWORK NTTTCP TCP: SYNTHETIC or SRIOV type. TBD.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """ALL
                    1\n2\n4\n8\n16\n32\n64\n128\n256\n512\n1024\n2048\n4096\n6144\n8192\n10240""",
            name: 'NTTTCP_TCP_CONNECTIONS',
            description: 'Azure Performance NETWORK NTTTCP TCP number of connections. TBD.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """SYNTHETIC
                    SRIOV""",
            name: 'NTTTCP_UDP_TYPE',
            description: 'Azure Performance NETWORK NTTTCP UDP: SYNTHETIC or SRIOV type. TBD.'],
        [$class: 'ChoiceParameterDefinition',
            choices: """ALL
                    2\n4\n8\n16\n32\n64\n128\n256\n512\n1024""",
            name: 'NTTTCP_UDP_CONNECTIONS',
            description: 'Azure Performance NETWORK NTTTCP UDP number of connections. TBD.'],
        [$class: 'StringParameterDefinition',
            name: 'CUSTOM_BUILD_TAG',
            defaultValue: "",
            description: 'Custom build tag for artifacts. If left undefined, BUILD_NUMBER will be used']
        ]
    ]
])

// ****************
// PIPELINE HELPERS
// ****************

def RunPowershellCommand(psCmd) {
    bat "powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command \"[Console]::OutputEncoding=[System.Text.Encoding]::UTF8;$psCmd;EXIT \$global:LastExitCode\""
}

def getVhdLocation(basePath, distroVersion) {
    def distroFamily = distroVersion.split('_')[0]
    return "${basePath}\\" + distroFamily + "\\" + distroVersion + "\\" + distroVersion + ".vhdx"
}

def prepareEnv(branch, remote) {
    cleanWs()
    git branch: branch, url: remote
}

def unstashKernel(kernelStash) {
    unstash kernelStash
    powershell """
        \$rmPath = "\${env:ProgramFiles}\\Git\\usr\\bin\\rm.exe"
        \$basePath = "./${env.BUILD_NUMBER}-${env.BRANCH_NAME}-${kernelStash}/*/${env.PACKAGE_TYPE}"

        & \$rmPath -rf "\${basePath}/*dbg*"
        & \$rmPath -rf "\${basePath}/*devel*"
        & \$rmPath -rf "\${basePath}/*debug*"
    """
}
// buildKernel method is using params:
//     params.KERNEL_GIT_URL
//     params.KERNEL_GIT_BRANCH
//     params.KERNEL_PATCH
//     params.CUSTOM_BUILD_TAG
def buildKernel() {
    if (!params.CUSTOM_BUILD_TAG) {
        env.CUSTOM_BUILD_TAG = env.BUILD_NUMBER
    }
    withCredentials(bindings: [string(credentialsId: 'MSFT_KERNEL_GIT_URL', variable: 'MSFT_KERNEL_GIT_URL'),
                               string(credentialsId: 'SCP_USERNAME_DEFAULT', variable: 'SCP_USERNAME_DEFAULT')]) {
        sh '''#!/bin/bash
              set -xe -o pipefail
              if [[ "$KERNEL_GIT_URL" == "azure_kernel" ]]; then
                  KERNEL_GIT_URL=${MSFT_KERNEL_GIT_URL}
              fi
              echo "Building artifacts..."
              pushd "$WORKSPACE/scripts/package_building"
              echo ${KERNEL_PATCH} | tr ' ' '\n' > developer_patches
              i='0'
              IFS=$'\t\n'
              for url in $(cat developer_patches); do
                  i=$(( i + 1 ))
                  protocol=${url%%://*}
                  url=${url#*//}
                  test_user=${url%%*@*}
                  if [[ $protocol == "scp" ]] && [[ $test_user != "" ]]; then
                      sed -i "${i}s/.*/scp:\\/\\/$SCP_USERNAME_DEFAULT@${url//\\//\\\\/}/" developer_patches
                  fi
              done
              IFS=$' '
              bash build_artifacts.sh \\
                  --git_url "${KERNEL_GIT_URL}" \\
                  --git_branch "${KERNEL_GIT_BRANCH}" \\
                  --destination_path "${BUILD_NUMBER}-${BRANCH_NAME}-${KERNEL_ARTIFACTS_PATH}" \\
                  --install_deps "True" \\
                  --thread_number "x3" \\
                  --debian_os_version "16" \\
                  --build_path "/mnt/tmp/developer-kernel-build-folder" \\
                  --kernel_config "Microsoft/config-azure" \\
                  --clean_env "True" \\
                  --use_ccache "True" \\
                  --use_kernel_folder_prefix "True" \\
                  --clone_depth "1" \\
                  --patch_file "developer_patches" \\
                  --create_changelog "False" \\
                  --custom_build_tag="${CUSTOM_BUILD_TAG}"
              popd
              '''
    }
    sh '''#!/bin/bash
      echo ${BUILD_NUMBER}-$(crudini --get scripts/package_building/kernel_versions.ini KERNEL_BUILT folder) > ./build_name
    '''
    script {
      currentBuild.displayName = readFile "./build_name"
    }
    stash includes: 'scripts/package_building/kernel_versions.ini', name: 'kernel_version_ini'
    dir ("scripts/package_building") {
        stash includes: "${env.BUILD_NUMBER}-${env.BRANCH_NAME}-${env.KERNEL_ARTIFACTS_PATH}/**/deb/**", name: env.KERNEL_ARTIFACTS_PATH
    }
    sh '''
        set -xe
        rm -rf "scripts/package_building/${BUILD_NUMBER}-${BRANCH_NAME}-${KERNEL_ARTIFACTS_PATH}"
        '''
    archiveArtifacts 'scripts/package_building/kernel_versions.ini'
}


def runLisa(platform, secrets, testName, testCategory, customTestParams) {
    def customKernel = ""
    def osVHD = ""
    def region = params.LISAV2_AZURE_REGION
    def vmSize = ""

    prepareEnv(env.LISAV2_BRANCH, env.LISAV2_REMOTE)
    try {
        unstashKernel(env.KERNEL_ARTIFACTS_PATH)
        customKernel = "-CustomKernel 'localfile:./${env.BUILD_NUMBER}-${env.BRANCH_NAME}-${env.KERNEL_ARTIFACTS_PATH}/*/deb/*.deb'"
    } catch (Exception e) {
        echo "No stash ${env.KERNEL_ARTIFACTS_PATH} found"
    }

    if (testName.equals(env.LISAV2_AZURE_STRESS_TEST)) {
        vmSize = "-OverrideVMSize '${params.AZURE_BOOT_STRESS_VM_SIZE}'"
    }
    if (platform.equals('HyperV')) {
        region = "localhost"
        if (testName.equals(env.LISAV2_PERFORMANCE_TEST)) {
            region = "localhost," + env.HYPERV_SECOND_PERF_NODE
        }
        osVHD = "-OsVHD '" + getVhdLocation(env.LISAV2_IMAGES_SHARE_URL, env.LISAV2_HYPERV_UBUNTU_IMAGE_BIONIC) + "'"
    }

    RunPowershellCommand(".\\Run-LisaV2.ps1" +
        " -TestLocation '${region}'" +
        " -RGIdentifier '${env.LISAV2_RG_IDENTIFIER}'" +
        " -TestPlatform '${platform}'" +
        " ${vmSize}" +
        " -ARMImageName '${env.LISAV2_AZURE_UBUNTU_IMAGE_BIONIC}'" +
        " ${osVHD}" +
        " ${customKernel}" +
        " -TestNames '${testName}'" +
        " -TestCategory '${testCategory}'" +
        " -CustomParameters '${customTestParams}'" +
        " -StorageAccount 'ExistingStorage_Standard'" +
        " -XMLSecretFile '${secrets}'"
    )
}


def publishArtifacts() {
    dir("${env.KERNEL_ARTIFACTS_PATH}${env.BUILD_NUMBER}${env.BRANCH_NAME}") {
        unstash "${env.KERNEL_ARTIFACTS_PATH}"
        withCredentials([string(credentialsId: 'MSFT_KERNEL_GIT_URL', variable: 'MSFT_KERNEL_GIT_URL'),
                         string(credentialsId: 'SMB_SHARE_URL', variable: 'SMB_SHARE_URL'),
                                usernamePassword(credentialsId: 'smb_share_user_pass',
                                passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')
                        ]) {
            sh '''#!/bin/bash
                set -xe
                if [[ "$KERNEL_GIT_URL" == "azure_kernel" ]]; then
                    KERNEL_GIT_URL=${MSFT_KERNEL_GIT_URL}
                fi
                folder_prefix="${KERNEL_GIT_URL##*/}"
                folder_prefix="${folder_prefix%.*}"
                mkdir -p "scripts/package_building"
                mv "${BUILD_NUMBER}-${BRANCH_NAME}-${KERNEL_ARTIFACTS_PATH}" "scripts/package_building/"
                bash "${WORKSPACE}/scripts/utils/publish_artifacts_to_smb.sh" \\
                    --build_number "${BUILD_NUMBER}-${BRANCH_NAME}" \\
                    --smb_url "${SMB_SHARE_URL}/${folder_prefix}" --smb_username "${USERNAME}" \\
                    --smb_password "${PASSWORD}" --artifacts_path "${KERNEL_ARTIFACTS_PATH}" \\
                    --artifacts_folder_prefix "${folder_prefix}"
                '''
        }
    }
}

def publishTempArtifacts() {
    dir("${env.KERNEL_ARTIFACTS_PATH}${env.BUILD_NUMBER}${env.BRANCH_NAME}") {
        unstash "${env.KERNEL_ARTIFACTS_PATH}"
        withCredentials([string(credentialsId: 'MSFT_KERNEL_GIT_URL', variable: 'MSFT_KERNEL_GIT_URL'),
                         string(credentialsId: 'SMB_SHARE_URL', variable: 'SMB_SHARE_URL'),
                            usernamePassword(credentialsId: 'smb_share_user_pass',
                                        passwordVariable: 'PASSWORD',
                                        usernameVariable: 'USERNAME')]) {
            sh '''#!/bin/bash
                set -xe
                if [[ "$KERNEL_GIT_URL" == "azure_kernel" ]]; then
                    KERNEL_GIT_URL=${MSFT_KERNEL_GIT_URL}
                fi
                folder_prefix="${KERNEL_GIT_URL##*/}"
                folder_prefix="${folder_prefix%.*}"
                mkdir -p "scripts/package_building"
                mv "${BUILD_NUMBER}-${BRANCH_NAME}-${KERNEL_ARTIFACTS_PATH}" "scripts/package_building/"
                bash "${WORKSPACE}/scripts/utils/publish_artifacts_to_smb.sh" \\
                    --build_number "${BUILD_NUMBER}-${BRANCH_NAME}" \\
                    --smb_url "${SMB_SHARE_URL}/temp-kernel-artifacts" --smb_username "${USERNAME}" \\
                    --smb_password "${PASSWORD}" --artifacts_path "${KERNEL_ARTIFACTS_PATH}" \\
                    --artifacts_folder_prefix "${folder_prefix}"
                '''
        }
    }
}

def stashArtifacts() {
    sh '''#!/bin/bash
        set -xe -o pipefail
        kernel_dir="${BUILD_NUMBER}-${BRANCH_NAME}-${KERNEL_ARTIFACTS_PATH}"
        mkdir -p "${kernel_dir}"
        cp -r "/mnt/kernels/${KERNEL_ARTIFACTS_SMB_PATH}" "${kernel_dir}"
    '''
    stash excludes: "${env.BUILD_NUMBER}-${env.BRANCH_NAME}-${env.KERNEL_ARTIFACTS_PATH}/**/${env.PACKAGE_TYPE}/*dbg*", includes: "${env.BUILD_NUMBER}-${env.BRANCH_NAME}-${env.KERNEL_ARTIFACTS_PATH}/**/${env.PACKAGE_TYPE}/**", name: env.KERNEL_ARTIFACTS_PATH
    cleanWs()
}

def getPerfTestInfo(perfType, netType, netIperfType, netIperfBufferLength) {
    def perfTestInfo = [ "test_case_name": 'NONE', "test_case_params": '']
    perfType = perfType.trim()
    netType = netType.trim()
    netIperfType = netIperfType.trim()
    netIperfBufferLength = netIperfBufferLength.trim()

    // LISAV2 TEST CASE INFORMATION
    def netIperfUSriovTestCase = "PERF-NETWORK-TCP-SINGLE-CONNECTION-THROUGHPUT-SRIOV"
    def netIperfSyntTestCase = "PERF-NETWORK-TCP-SINGLE-CONNECTION-THROUGHPUT-SYNTHETIC"
    def netIperfBufferLengthAll = "32 64 128 256 512 1024 2048 4096 8192 16384 32768 65536"
    def netIperfSriovBufferLengthParam = "PERF-NETWORK-TCP-SINGLE-CONNECTION-THROUGHPUT-SRIOV-BUFFER-LENGTHS"
    def netIperfSyntBufferLengthParam = "PERF-NETWORK-TCP-SINGLE-CONNECTION-THROUGHPUT-SYNTHETIC-BUFFER-LENGTHS"
    def netIperfBufferLengthParam

    switch (perfType) {
        case "STORAGE":
            echo "STORAGE perf tests are not implemented."
            break
        case "NETWORK":
            switch (netType) {
                case "IPERF3_1CONNECTION":
                    if (netIperfType.equals("SYNTHETIC")) {
                        perfTestInfo["test_case_name"] = netIperfSyntTestCase
                        netIperfBufferLengthParam = netIperfSyntBufferLengthParam
                    }
                    if (netIperfType.equals("SRIOV")) {
                        perfTestInfo["test_case_name"] = netIperfUSriovTestCase
                        netIperfBufferLengthParam = netIperfSriovBufferLengthParam
                    }
                    if (netIperfBufferLength.equals("ALL")) {
                        netIperfBufferLength = netIperfBufferLengthAll
                    }
                    perfTestInfo["test_case_params"] = "(" + netIperfBufferLength + ")"
                    perfTestInfo["test_case_params"] = netIperfBufferLengthParam + "=" + perfTestInfo["test_case_params"]
                    break;
                default:
                    echo "NETWORK ${netType} perf tests are not implemented."
                    break
            }
            break
        default:
            echo "${perfType} perf tests are not implemented."
            break
    }
    return perfTestInfo
}

// **************
// PIPELINE LOGIC
// **************

if (params.RUN_AZURE_BOOT_TEST) {
    runs['azure_boot'] = {
        node ("azure") {
            stage ("azure_boot") {
                try {
                    echo "Running Azure Boot test"
                    withCredentials(bindings: [
                      file(credentialsId: 'Azure_Secrets_File',
                           variable: 'Azure_Secrets_File')
                    ]) {
                        runLisa('Azure', env.Azure_Secrets_File, 'BVT-CORE-VERIFY-LIS-MODULES', '', '')
                    }
                } catch (Exception e) {
                    echo e.toString()
                    echo "Failed to run Azure Boot test"
                    currentBuild.result = 'FAILURE'
                } finally {
                    junit "Report\\*-junit.xml"
                    powershell "Move-Item -Force Report\\*-junit.xml Report\\AZURE_BOOT_TEST.xml"
                    archive "Report\\AZURE_BOOT_TEST.xml"
                    archiveArtifacts "TestResults\\**\\*"
                }
            }
        }
    }
}

if (params.RUN_AZURE_BOOT_STRESS_TEST) {
    runs['azure_boot_stress'] = {
        node ("azure") {
            stage ("azure_boot_stress") {
                try {
                    echo "Running Azure Boot Stress tests"
                    withCredentials(bindings: [
                      file(credentialsId: 'Azure_Secrets_File',
                           variable: 'Azure_Secrets_File')
                    ]) {
                        runLisa('Azure', env.Azure_Secrets_File, env.LISAV2_AZURE_STRESS_TEST, '', '')
                    }
                } catch (Exception e) {
                    echo e.toString()
                    echo "Failed to run Azure Boot Stress test"
                    currentBuild.result = 'FAILURE'
                } finally {
                    junit "Report\\*-junit.xml"
                    powershell "Move-Item -Force Report\\*-junit.xml Report\\AZURE_BOOT_STRESS_TEST.xml"
                    archive "Report\\AZURE_BOOT_STRESS_TEST.xml"
                    archiveArtifacts "TestResults\\**\\*"
                }
            }
        }
    }
}

if (params.RUN_AZURE_BVT_TESTS) {
    runs['azure_bvt'] = {
        node ("azure") {
            stage ("azure_bvt") {
                try {
                    echo "Running Azure BVT tests"
                    withCredentials(bindings: [
                      file(credentialsId: 'Azure_Secrets_File',
                           variable: 'Azure_Secrets_File')
                    ]) {
                        runLisa('Azure', env.Azure_Secrets_File, '', 'BVT', '')
                    }
                } catch (Exception e) {
                    echo e.toString()
                    echo "Failed to run Azure BVT tests"
                    currentBuild.result = 'FAILURE'
                } finally {
                    junit "Report\\*-junit.xml"
                    powershell "Move-Item -Force Report\\*-junit.xml Report\\AZURE_BVT_TESTS.xml"
                    archive "Report\\AZURE_BVT_TESTS.xml"
                    archiveArtifacts "TestResults\\**\\*"
                }
            }
        }
    }
}

if (params.RUN_HYPERV_BVT_TESTS) {
    runs['hyperv_bvt'] = {
        node ("hyper-v") {
            stage ("hyperv_bvt") {
                try {
                    echo "Running HyperV BVT tests"
                    withCredentials(bindings: [
                      file(credentialsId: 'Azure_Secrets_File',
                           variable: 'Azure_Secrets_File'),
                      string(credentialsId: 'LISAV2_IMAGES_SHARE_URL',
                             variable: 'LISAV2_IMAGES_SHARE_URL')
                    ]) {
                        runLisa('HyperV', env.Azure_Secrets_File, '', 'BVT', '')
                    }
                } catch (Exception e) {
                    echo e.toString()
                    echo "Failed to run HyperV BVT tests"
                    currentBuild.result = 'FAILURE'
                } finally {
                    junit "Report\\*-junit.xml"
                    powershell "Move-Item -Force Report\\*-junit.xml Report\\HYPERV_BVT_TESTS.xml"
                    archive "Report\\HYPERV_BVT_TESTS.xml"
                    archiveArtifacts "TestResults\\**\\*"
                }
            }
        }
    }
}

if (params.AZURE_PERF_TESTS && !params.AZURE_PERF_TESTS.equals('NONE')) {
    def perfTestInfo = getPerfTestInfo(params.AZURE_PERF_TESTS, params.AZURE_PERF_NETWORK_TEST_TYPE, params.NET_IPERF3_TYPE, params.NET_IPERF3_BUFFER_LENGTH)
    if (!perfTestInfo["test_case_name"].equals("NONE")) {
            runs['azure_perf'] = {
            node ("azure") {
                stage ("azure_perf") {
                    try {
                        echo "Running Azure performance tests"
                        withCredentials(bindings: [
                          file(credentialsId: 'Azure_Secrets_File',
                               variable: 'Azure_Secrets_File'),
                          string(credentialsId: 'LISAV2_IMAGES_SHARE_URL',
                                 variable: 'LISAV2_IMAGES_SHARE_URL')
                        ]) {
                            runLisa('Azure', env.Azure_Secrets_File, perfTestInfo["test_case_name"], '', perfTestInfo['test_case_params'])
                        }
                    } catch (Exception e) {
                        echo e.toString()
                        echo "Failed to run Azure performance tests"
                        currentBuild.result = 'FAILURE'
                    } finally {
                        junit "Report\\*-junit.xml"
                        powershell 'ls -Recurse TestResults\\** | Where-Object {$_.Name -like "*_perf_results.json"} | ForEach-Object {Copy-Item $_ "Report\\AZURE_PERF_TESTSSUITE$($_.Name)"}'
                        powershell "Move-Item -Force Report\\*-junit.xml Report\\AZURE_PERF_TESTS.xml"
                        archive "Report\\AZURE_PERF_TESTS*"
                        archiveArtifacts "TestResults\\**\\*"
                    }
                }
            }
        }
    }
}

// *************
// PIPELINE MAIN
// *************

if (params.BUILD_KERNEL_ARTIFACTS) {
    node ("ubuntu_kernel_builder") {
        stage ("build_artifacts") {
            checkout scm
            buildKernel()
        }
    }
    node ("meta_slave") {
        stage ("publish_temp_artifacts") {
            checkout scm
            publishTempArtifacts()
        }
    }
} else {
    if (params.KERNEL_ARTIFACTS_SMB_PATH) {
        node ("meta_slave") {
            stage ("stash_artifacts") {
                stashArtifacts()
            }
        }
    }
}

stage("validation_stage") {
    parallel runs
}

if (params.BUILD_KERNEL_ARTIFACTS) {
    node ("meta_slave") {
        stage ("publish_artifacts") {
            checkout scm
            publishArtifacts()
        }
    }
}